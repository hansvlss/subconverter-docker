name: build

on:
  workflow_dispatch:
    inputs:
      sc_ver:
        description: "subconverter release tag (e.g. v0.9.0)"
        required: false
        default: "v0.9.0"
  push:
    branches: [ main, master ]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/subconverter
  SC_VER: ${{ inputs.sc_ver || 'v0.9.0' }}
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare build context
        shell: bash
        run: |
          set -eux
          mkdir -p ctx/vendor ctx/rootfs/etc/subconverter

          cat > ctx/entrypoint.sh <<'SH'
          #!/usr/bin/env sh
          set -eu
          : "${SC_PORT:=25500}"
          : "${SC_ADDR:=0.0.0.0}"
          : "${SC_ARGS:=}"
          BIN="/opt/subconverter/subconverter"
          if [ ! -x "$BIN" ]; then
            echo "subconverter binary not found or not executable" >&2
            ls -al /opt/subconverter || true
            chmod +x "$BIN" 2>/dev/null || true
          fi
          exec "$BIN" -localaddr "${SC_ADDR}:${SC_PORT}" $SC_ARGS
          SH
          chmod +x ctx/entrypoint.sh

          cat > ctx/rootfs/etc/subconverter/pref.ini <<'INI'
          [common]
          api_access = true
          port = 25500
          INI

          cat > ctx/.dockerignore <<'IGNORE'
          .git
          .github
          **/.DS_Store
          IGNORE

          cat > ctx/Dockerfile <<'DOCKER'
          FROM alpine:3.20
          ARG TARGETARCH
          ARG SC_HOME=/opt/subconverter
          RUN set -eux; \
              apk add --no-cache ca-certificates tzdata bash curl libstdc++; \
              adduser -D -h /home/app app; \
              mkdir -p ${SC_HOME}
          COPY vendor/ /tmp/vendor/
          RUN set -eux; \
              case "${TARGETARCH}" in \
                amd64)  ARCH=linux64 ;; \
                arm64)  ARCH=linuxarm64 ;; \
                *) echo "Unsupported TARGETARCH: ${TARGETARCH}"; exit 1 ;; \
              esac; \
              PKG="/tmp/vendor/subconverter_${ARCH}"; \
              [ -f "$PKG" ] || (echo "vendor package missing"; ls -al /tmp/vendor; exit 2); \
              echo ">>> installing binary $PKG"; \
              mv "$PKG" "${SC_HOME}/subconverter"; \
              chmod +x "${SC_HOME}/subconverter"; \
              chown -R app:app "${SC_HOME}"
          COPY entrypoint.sh /entrypoint.sh
          COPY rootfs/ /
          EXPOSE 25500
          USER app
          ENV SC_PORT=25500 SC_ADDR=0.0.0.0
          ENTRYPOINT ["/entrypoint.sh"]
          DOCKER

      - name: Prepare vendor (auto-detect file format)
        shell: bash
        run: |
          set -eux
          cd ctx
          mkdir -p vendor

          VER="${SC_VER:-v0.9.0}"
          N="${VER#v}"; VER="v${N}"

          for ARCH in linux64 linuxarm64; do
            FILE="vendor/subconverter_${ARCH}"
            FOUND=0
            for NAME in \
              "subconverter_${ARCH}" \
              "subconverter_${ARCH}.tar.gz" \
              "subconverter_${ARCH}.zip"
            do
              for BASE in \
                "https://github.com/tindy2013/subconverter/releases/download/${VER}" \
                "https://download.fastgit.org/tindy2013/subconverter/releases/download/${VER}" \
                "https://ghproxy.net/https://github.com/tindy2013/subconverter/releases/download/${VER}"
              do
                URL="${BASE}/${NAME}"
                echo ">>> trying ${URL}"
                if curl -fL --retry 5 -o "$FILE" "$URL"; then
                  echo "✅ downloaded $NAME"
                  FOUND=1
                  break 2
                fi
              done
            done
            if [ $FOUND -eq 0 ]; then
              echo "❌ failed to download subconverter_${ARCH}"
              exit 22
            fi
          done

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VER="${SC_VER#v}"
          echo "ver=${VER}" >> "$GITHUB_OUTPUT"
          TAGS="${IMAGE_NAME}:${VER}-auto"
          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: ctx
          file: ctx/Dockerfile
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
